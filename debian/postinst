#!/bin/bash -e

#DEBHELPER#

function generate_domains_type() {
	alternc_version=$1
	php_list=$(find /etc/php -type d -iname "[0-9]*" |sed 's/^[^0-9]*//')
	sql=""
	sql_in=""
	set_default=""

	if dpkg --compare-versions "${alternc_version:-0}" ">>" "3.5"; then
		set_default="has_https_option=1,"
	fi

	for php_version in $php_list
	do
		type_name="php${php_version/[^0-9]/}-fpm"	
		sql="$sql \
			INSERT IGNORE INTO domaines_type SET \
				name='$type_name', \
				description='PHP $php_version FPM', \
				target='DIRECTORY', \
				entry='%SUB% IN A @@PUBLIC_IP@@', \
				compatibility='txt,defmx,defmx2,mx,mx2', \
				enable='ALL', \
				need_dns=0, \
				$set_default \
				create_targetdir=1 \
			;"
		sql_in="$sql_in,'$type_name'"
	done

	sql="$sql\
		UPDATE sub_domaines SET web_action='UPDATE' WHERE type IN (${sql_in/,/});
	"

	mysql --defaults-file=/etc/alternc/my.cnf -e "$sql"
}

case "$1" in
    configure)
	echo "Configure template apache"
	templates_path="/etc/alternc/templates/"
	templates_source_apache="$templates_path/3.5/apache2/"
	alternc_version=$(dpkg-query --showformat='${Version}\n' --show alternc)
	if [[ -n "$alternc_version" ]]; then
        if dpkg --compare-versions "${alternc_version:-0}" "<<" "3.5"; then
            templates_source_apache="$templates_path/3.3/apache2"
        fi
        for template in "$templates_source_apache"/*.conf; do
                template_name=$(basename "$template")
                ln -sf "$template" "$templates_path/apache2/$template_name"
        done
	fi

	echo "Enabling apache modules"
	a2enmod proxy_fcgi setenvif
	service apache2 restart
	echo "Installing mysql table"
	generate_domains_type "$alternc_version"
	echo "Overriding php fpm configuration..."
	/usr/lib/alternc/php7-fpm force
	;;

    triggered)
	echo "Alternc PHP FPM"
	printf "\tUpdate php domains type"
	generate_domains_type "$alternc_version"
    ;;

esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.
#DEBHELPER#

